#!/usr/bin/env python3

"""
Phynteny: synteny-based annotation of phage genes
"""

import sys
import click
from phynteny_utils import handle_genbank
from phynteny_utils import predictor
from Bio import SeqIO
import pkg_resources
import pickle5
import numpy as np 

__author__ = "Susanna Grigson"
__maintainer__ = "Susanna Grigson"
__license__ = "MIT"
__version__ = "0"
__email__ = "susie.grigson@gmail.com"
__status__ = "development"

@click.command()
@click.argument("infile", type=click.Path(exists=True))
@click.option(
    "-o",
    "--outfile", 
    type=click.Path(), 
    help="where to write the output genbank file",
)
@click.option(
    "-m",
    "--model",
    type=click.Path(exists=True),
    help="Path to custom LSTM model",
    default=pkg_resources.resource_filename('phynteny_utils', 'model'),
)
@click.option(
    "-c",
    "--confidence_path",
    type=click.Path(exists=True),
    help="Dictionary of kernel desnity estimators to use for predicting confidence",
    default=pkg_resources.resource_filename('phynteny_utils', 'phrog_annotation_info/confidence_kde.pkl')
)
@click.version_option(version=__version__)

def main(infile, outfile, model, confidence_path):
    """
    Phynteny: synteny-based annotation of phage genes
    """

    # get the absolute paths to phrog annotation files, model and confidence_kde
    phrog_categories = pkg_resources.resource_filename('phynteny_utils', 'phrog_annotation_info/phrog_integer.pkl')
    category_names = pkg_resources.resource_filename('phynteny_utils', 'phrog_annotation_info/integer_category.pkl')

    # get entries in the genbank file
    print('Reading genbank file!')
    gb_dict = handle_genbank.get_genbank(infile)
    if not gb_dict:
        click.echo("Error: no sequences found in genbank file")
        sys.exit()
    keys = list(gb_dict.keys())

    # create predictor object
    gene_predictor = predictor.Predictor(model, phrog_categories, confidence_path, category_names)
    print(model) 
    # Run Phynteny
    with click.open_file(outfile, "wt") if outfile else sys.stdout as handle:

        for key in keys:

            # print the phage 
            print('Annotating the phage: ' + key, flush=True) 

            # get current phage
            phages = {key: handle_genbank.extract_features(gb_dict.get(key))}

            # get phrog annotations
            phages[key]["phrogs"] = [
                0 if i == "No_PHROG" else int(i) for i in phages[key]["phrogs"]
            ]

            # make predictions
            unk_idx, predictions, scores, confidence = gene_predictor.predict_annotations(phages)
            
            #print(len(predictions))
             
            # update with these annotations
            cds = [i for i in gb_dict.get(key).features if i.type == "CDS"]
            
            # return everything back 
            for i in range(len(unk_idx)):
                cds[unk_idx[i]].qualifiers["phynteny"] = category_names.get(predictions[i]) 
                cds[unk_idx[i]].qualifiers["phynteny_score"] = np.max(scores[i])
                cds[unk_idx[i]].qualifiers["phynteny_confidence"] = confidence[i]

            # write to genbank file
            SeqIO.write(gb_dict.get(key), handle, "genbank")

            # TODO write to a table format as well that contains the positions and the location of each annotation 
    
    if outfile: 
        print('DONE')

if __name__ == "__main__":
    main()

